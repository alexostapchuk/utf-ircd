#! /bin/sh

quick_fwd=
no_rusnet=
default_locale=uk_UA.KOI8-U
for arg
do
  case "$arg" in
    -help | --help | --hel | --he)
      quick_fwd=yes
      break ;;
    -version | --version | --versio | --versi | --vers)
      quick_fwd=yes
      break ;;
    # --no-rusnet should be first option, it disables rusnet-specific tests
    -no-rusnet | --no-rusnet | --no-rus)
      no_rusnet=yes
      shift
      ;;
    *)
      ;;
  esac
done
if test "x$quick_fwd" = xyes
then
  support/configure "$@"
else
  echo "retrieving the system name, type and OS release..."
  rev=`support/config.guess`
  if test "${rev}" 		# test for no output
  then
    echo "  your system seems to be ${rev}."
    if test ! -d "${rev}"
    then
      echo "creating directory ${rev}..."
      mkdir "${rev}"
    fi
    cd "${rev}"
    echo "now working in directory ${rev}..."
    cp -p ../support/configure .
   if test ! -f config.h
   then
     echo "copying config.h from config.h.dist..."
     cp -p ../support/config.h.dist config.h
   fi
    add_to_configure=
    NO_UTF_LOCALE=
    if test x$no_rusnet = x
    then
	# test for desired locale support
	if (export LC_ALL=$default_locale; echo "ðòï³í" | \
				grep -i "ÐÒÏ£Í" >/dev/null); then
		# test for uk_UA.UTF-8
		(export LC_ALL=uk_UA.UTF-8; echo "ÐŸÐ ÐžÐÐœ" | \
						grep -i "Ð¿Ñ€Ð¾Ñ‘Ð¼" >/dev/null) || {
			echo -e "
WARNING: UTF locale doesn't work, disabling IRCD_CHANGE_LOCALE
"
			NO_UTF_LOCALE=yes
		}
	else
		echo -e "
ERROR: Cannot find working locale, disabling iconv in ircd!
"
		add_to_configure="--enable-iconv=no"
	fi
    fi
    export NO_UTF_LOCALE
    ./configure "$@" $add_to_configure
    if test $? = 0
    then
      echo -e "
******************************************************
Have you ever read \033[1mrusnet-doc/RUSNET_DOC\033[0m?
Do not proceed before thorough reading of this file.

Your next step is: 
cd ${rev}
edit \"config.h\"
run \"make\" to build and
run \"make install\" to install.

NOTE:
RusNet IRCD development team has made the most 
necessary changes to config.h. You might want to change
\033[1mUID/GID\033[0m and \033[1mMAXCONNECTIONS\033[0m only.

IT IS IMPERATIVE THAT YOU SHOULD READ 
\033[1mrusnet-doc/INSTALL\033[0m BEFORE RUNNING THE SERVER.
*******************************************************
"
    fi
  else
    echo Failed to determine your host type, giving up.
    echo Perhaps you should specify it manually.
  fi
fi
